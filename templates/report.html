<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Financial Report</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        
        /* HEADER */
        .page-header { 
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); 
            color: white; padding: 20px 20px 80px 20px; text-align: center; 
            border-radius: 0 0 20px 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .container { 
            max-width: 1100px; margin: -50px auto 20px; background: #fff; 
            padding: 30px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); 
        }

        /* SEARCH BAR */
        .search-wrapper { display: flex; gap: 10px; justify-content: center; margin-bottom: 30px; }
        .search-input { 
            padding: 12px 20px; width: 60%; border: 2px solid #eee; border-radius: 50px; 
            font-size: 16px; outline: none; transition: 0.3s;
        }
        .search-input:focus { border-color: #3498db; }
        .btn-search { 
            background: #2c3e50; color: white; padding: 12px 30px; border: none; 
            border-radius: 50px; font-weight: bold; cursor: pointer; 
        }

        /* TABLE DESIGN (Row Form) */
        .finance-table {
            width: 100%; border-collapse: collapse; margin-top: 10px;
        }
        .finance-table th {
            background: #f8f9fa; color: #555; font-weight: bold; text-align: left;
            padding: 15px; border-bottom: 2px solid #eee; text-transform: uppercase; font-size: 12px;
        }
        .finance-table td {
            padding: 12px 15px; border-bottom: 1px solid #eee; vertical-align: middle; color: #333;
        }
        .finance-table tr:hover { background-color: #fcfcfc; }

        /* BALANCE HIGHLIGHT */
        .balance-cell { font-weight: bold; font-size: 16px; color: #e74c3c; }

        /* COMPACT ACTION BUTTONS */
        .btn-action {
            padding: 6px 12px; border: none; border-radius: 4px; font-weight: bold; 
            font-size: 12px; cursor: pointer; display: inline-block; margin-right: 5px;
            color: white; text-transform: uppercase;
        }
        .btn-add { background-color: #e74c3c; } /* Red for Adding Debt */
        .btn-pay { background-color: #27ae60; } /* Green for Payment */
        
        .btn-add:hover { background-color: #c0392b; }
        .btn-pay:hover { background-color: #219150; }

        /* MODAL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 25px; border-radius: 10px; width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .modal-input { width: 100%; padding: 10px; margin: 15px 0; border: 1px solid #ccc; border-radius: 5px; font-size: 18px; text-align: center; }
    </style>
</head>
<body>

    <div class="page-header">
        <h1>üí∞ Financial Report</h1>
        <p>Search Customer to Manage Payments</p>
        <a href="/" style="position: absolute; top: 20px; left: 20px; color: white; text-decoration: none; border: 1px solid rgba(255,255,255,0.5); padding: 5px 15px; border-radius: 20px;">üè† Home</a>
    </div>

    <div class="container">
        
        <form method="POST" class="search-wrapper">
            <input type="text" name="search_query" class="search-input" placeholder="Enter ID, Name, or Phone Number..." value="{{ search_query }}" autofocus required>
            <button type="submit" class="btn-search">Search</button>
        </form>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div style="padding:10px; margin-bottom:20px; border-radius:5px; text-align:center; background:{% if category=='success' %}#d4edda{% elif category=='danger' %}#f8d7da{% else %}#fff3cd{% endif %}; color:{% if category=='success' %}#155724{% elif category=='danger' %}#721c24{% else %}#856404{% endif %};">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% if users %}
        <table class="finance-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Phone</th>
                    <th>Date</th>
                    <th style="text-align:center;">Suits</th>
                    <th>Remaining Balance</th>
                    <th style="text-align:right;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td><strong>{{ user.userId }}</strong></td>
                    <td>{{ user.userName }}</td>
                    <td>{{ user.phone }}</td>
                    <td>{{ user.date.strftime('%d-%m-%Y') }}</td>
                    <td style="text-align:center;">{{ user.numberOfSuit }}</td>
                    <td class="balance-cell">{{ user.price or 0 }}</td>
                    <td style="text-align:right;">
                        <button onclick="openModal('{{ user.userId }}', '{{ user.userName }}', 'add_debt')" class="btn-action btn-add">
                            ‚ûï Add
                        </button>

                        <button onclick="openModal('{{ user.userId }}', '{{ user.userName }}', 'payment')" class="btn-action btn-pay">
                            üíµ Pay
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        {% elif search_query %}
            <div style="text-align:center; color:#777; padding:40px;">No customer found with those details.</div>
        {% else %}
            <div style="text-align:center; color:#999; padding:40px;">Search to view customer details.</div>
        {% endif %}

    </div>

    <div id="transModal" class="modal-overlay">
        <div class="modal-box">
            <h2 id="modalTitle" style="margin-top:0;"></h2>
            <p>Customer: <strong id="modalName"></strong></p>
            
            <form action="/process_transaction" method="POST">
                <input type="hidden" name="user_id" id="modalUserId">
                <input type="hidden" name="type" id="modalType">
                
                <input type="number" name="amount" class="modal-input" placeholder="Enter Amount" required autofocus>
                
                <div style="display:flex; gap:10px;">
                    <button type="button" onclick="closeModal()" style="flex:1; padding:10px; background:#ccc; border:none; border-radius:5px; cursor:pointer;">Cancel</button>
                    <button type="submit" id="modalSubmitBtn" style="flex:1; padding:10px; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold;">Confirm</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function openModal(id, name, type) {
            document.getElementById('modalUserId').value = id;
            document.getElementById('modalName').innerText = name;
            document.getElementById('modalType').value = type;
            
            const title = document.getElementById('modalTitle');
            const btn = document.getElementById('modalSubmitBtn');

            if (type === 'add_debt') {
                title.innerText = "Add Remaining Amount";
                title.style.color = "#e74c3c";
                btn.innerText = "Add Debt";
                btn.style.backgroundColor = "#e74c3c";
            } else {
                title.innerText = "Receive Payment";
                title.style.color = "#27ae60";
                btn.innerText = "Receive Payment";
                btn.style.backgroundColor = "#27ae60";
            }
            
            document.getElementById('transModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('transModal').style.display = 'none';
        }

        window.onclick = function(e) {
            if (e.target == document.getElementById('transModal')) closeModal();
        }
    </script>

</body>
</html>